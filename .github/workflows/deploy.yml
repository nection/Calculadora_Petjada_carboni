# Nom del procés que veuràs a GitHub
name: Desplegament de la Calculadora de Carboni

# Aquesta acció s'activa cada cop que fas un 'push' a la branca 'main'
on:
  push:
    branches:
      - main

# Defineix les tasques que s'han d'executar
jobs:
  deploy:
    # L'automatització s'executa en un servidor de GitHub amb Ubuntu
    runs-on: ubuntu-latest

    # Defineix els passos del procés
    steps:
      # Aquest és l'únic pas: connectar-se al teu servidor i executar les comandes
      - name: Connectar, actualitzar i reiniciar la Calculadora de Carboni
        # Usem una acció pre-feta per facilitar la connexió SSH
        uses: appleboy/ssh-action@master
        with:
          # Agafem les dades dels secrets amb els noms CORRECTES
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2244 # <--- El teu port segur
          
          # Aquestes són les comandes adaptades per al NOU projecte
          script: |
            # 1. Anem a la carpeta de la Calculadora de Carboni
            cd /var/www/Calculadora_Petjada_carboni
            
            # 2. Descarreguem l'últim estat del repositori remot
            git fetch origin main
            
            # 3. Forcem que els arxius siguin un clon exacte de la versió remota
            git reset --hard origin/main
            
            # 4. Instal·lem les dependències de producció de forma neta
            # (npm ci és més ràpid i segur que npm install per a producció)
            npm ci --production
            
            # 5. Reiniciem l'aplicació amb PM2 amb el nom CORRECTE
            pm2 restart calculadora-carboni